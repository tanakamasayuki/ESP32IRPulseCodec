# ITPS 仕様

## 1. 目的
ITPS（Intermediate Timed Pulse Sequence）は、IR波形（Mark/Spaceの時間列）を **機種非依存** に表現するための中間フォーマットである。  
ESP32固有のRMT等は送受信の直前（HAL層）で吸収し、デコーダ/エンコーダはITPSを入出力として移植性を確保する。

## 2. データモデル
IRデータは **フレームの配列** として表現する（フレーム境界は配列で保持し、ITPS内部に区切りトークン等は持たない）。

### 2.1 ITPSFrame 構造
ITPSFrameは以下を保持する：

- `uint16_t T_us`  
  1カウントあたりの時間（マイクロ秒）。
- `uint16_t len`  
  `seq[]` の要素数。
- `int8_t seq[len]`  
  Mark/Spaceの区間列。符号で極性、絶対値で期間を表す。
- `uint8_t flags`  
  メタ情報をビットで保持する（利用者が直接操作することは想定しない）。

## 3. seq[] の意味
`seq[i]` は1つの区間を表す。

- `seq[i] > 0`：Mark（キャリアON／IR点灯）
- `seq[i] < 0`：Space（キャリアOFF／IR消灯）
- 区間時間（us）は `abs(seq[i]) * T_us`

## 4. 正規化（Normalize）の保証
ITPSFrameは、デコーダ/エンコーダが扱いやすく、かつ8bit制約下で長大データでも破綻しないよう、**正規化済みの標準形**として扱う。

正規化済み ITPSFrame は次を満たす：

1. **要素値の範囲**
   - `seq[i] != 0`
   - `1 <= abs(seq[i]) <= 127`

2. **開始極性**
   - `seq[0] > 0`（常にMark開始）
   - 受信生データがSpace開始であっても、ITPS化の段階で先頭の無意味なSpaceは除去し、Mark開始に統一する。

3. **同符号連続の扱い（8bit制約への対応）**
   - 同符号（Mark同士、またはSpace同士）が連続してよい。これは **±127分割** によって長時間区間を表現するためである。
   - ただし、**無意味な分割は残さない**。
     - 隣接する同符号要素について、両方の絶対値が127未満の場合は結合し、1要素にまとめる。
     - 結合結果の絶対値が127を超える場合は、±127単位で分割して保持する。

4. **flagsの整合**
   - 正規化済みデータでは `START_MARK` を1とする。
   - `NORMALIZED` を1とする。

## 5. flags ビット割り当て（推奨）
- bit0: `START_MARK`
- bit1: `NORMALIZED`
- bit2: `HAS_TRAILING_GAP`
- bit3..7: 予約

## 6. 反転（INVERTED）の扱い
反転は **ITPSの属性としない**。  
受信・送信の直前（HAL層）で吸収する。

- ITPSは常に「Mark=正、Space=負」を保証する。
- 反転を適用した事実を残す場合は、RxResultやTxResult等のI/Oメタ情報として保持する。
