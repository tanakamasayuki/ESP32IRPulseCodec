# ITPS 仕様

## 1. 目的
ITPS（Intermediate Timed Pulse Sequence）は、IR波形（Mark/Spaceの時間列）を **機種・ボード非依存** に表現するための中間フォーマットである。  
タイマやキャプチャ/送信ペリフェラルなどハード依存の差異は送受信直前の実装依存層（HAL等）で吸収し、デコーダ/エンコーダは ITPS を入出力として移植性を確保する。

## 2. データモデル
IRデータは **フレームの配列** として表現する（フレーム境界は配列で保持し、ITPS内部に区切りトークン等は持たない）。
シリアライズ形式（バイト列/JSON/テキスト等）は本仕様の範囲外であり、項目名やレイアウトは実装側で自由に決めてよい。

### 2.1 ITPSFrame 構造
ITPSFrameは以下を保持する：

- `uint16_t T_us`  
  1カウントあたりの時間（マイクロ秒）。
- `uint16_t len`  
  `seq[]` の要素数。
- `int8_t seq[len]`  
  Mark/Spaceの区間列。符号で極性、絶対値で期間を表す。
- `uint8_t flags`  
  拡張用のメタ情報。ビット/値の意味付けは実装依存で、未使用なら0。

#### T_us の扱い
- `T_us` は ITPSFrame の必須フィールドで、`seq` のカウント値を実時間(us)に戻すスケールを示す。
- ITPS として扱うデータは、同一列（フレーム配列）内で `T_us` が共通であることを前提とする。欠落や不一致を許容するフォーマットではない。
- `T_us` 自体に論理的意味は持たせず、デコード/エンコード時は実時間へ変換して判定する。
- 選定の目安（参考）：受信は 1–10us 程度の量子化を想定。エアコン等の長大波形を含む場合は 5us 程度、短いリモコン中心なら 1us 近辺を想定。プロトコルで分解能が規定される場合（例：NEC送信）はその値を用いる。`T_us` を小さくすれば誤差減・データ長増、大きくすればデータ短縮・誤差増となる。データ長最小化のための過剰な最適化は不要。
- 時間計算のレンジ：区間時間 `abs(seq[i]) * T_us` やフレーム総時間の計算には少なくとも 32bit 符号なしを推奨する。数百ms〜秒単位のフレームを扱う場合でも、`T_us=5us` 程度であれば 32bit で十分なレンジが確保できる。

### 2.2 フレーム境界とギャップの扱い
- 1フレームは「連続送出される Mark/Space 列」を表し、フレーム境界は配列構造で区切る。
- 必要に応じて末尾にガード/区切り用の Space を含めてもよい（終端極性の制約は設けない）。フレーム境界やギャップの扱いは生成側のポリシーに委ねる。
- 境界を切る際の参考：長いSpace（例: ギャップ相当）で区切る、プロトコルのリピート/再送区間を別フレームにする、などのポリシーを生成側が決めてよい。ITPS自体は区切り方法に依存しない。

### 2.3 所有権と配置
- `seq` は読み取り専用として扱い、ITPSの利用者が書き換えない前提とする。
- `seq` の実体はRAM/ROM/フラッシュいずれでもよい。寿命管理は生成側（呼び出し側）が担う。

## 3. seq[] の意味
`seq[i]` は1つの区間を表す。

- `seq[i] > 0`：Mark（キャリアON／IR点灯）
- `seq[i] < 0`：Space（キャリアOFF／IR消灯）
- 区間時間（us）は `abs(seq[i]) * T_us`

## 4. 正規化（Normalize）の保証
ITPSFrameは、デコーダ/エンコーダが扱いやすく、かつ8bit制約下で長大データでも破綻しないよう、**正規化済みの標準形**として扱う。

正規化済み ITPSFrame は次を満たす：

1. **要素値の範囲**
   - `seq[i] != 0`
   - `1 <= abs(seq[i]) <= 127`
   - `int8_t` 範囲だが `-128` は使用しない（絶対値は127まで）

2. **開始極性**
   - `seq[0] > 0`（常にMark開始）
   - 受信生データがSpace開始であっても、ITPS化の段階で先頭の無意味なSpaceは除去し、Mark開始に統一する。

3. **同符号連続の扱い（8bit制約への対応）**
   - 同符号（Mark同士、またはSpace同士）が連続してよい。これは **±127分割** によって長時間区間を表現するためである。
   - ただし、**無意味な分割は残さない**。
     - 隣接する同符号要素について、両方の絶対値が127未満の場合は結合し、1要素にまとめる。
     - 結合結果の絶対値が127を超える場合は、±127単位で分割して保持する。
   - `abs(seq[i])==127` の後に極性が変わる場合もありうるので、「127が出たら必ず連続している」とは限らない。実時間復元時は隣接要素の符号を見て連結可否を判断する。

4. **入力前提**
   - 時間量子化（`T_us` 決定）および微小ノイズ除去は ITPS 化の前段で済ませることを前提とする。

5. **無効条件**
   - `len == 0`、`seq` が null、`T_us == 0` は無効。
   - `seq[0] <= 0`、`abs(seq[i]) > 127`、`seq[i] == 0` は無効。
   - `len` は少なくとも `uint16_t` で表現できる幅を持たせることを推奨する。実装はこれ以上の幅を用いて長大フレームに対応してよい（具体的上限は実装依存）。

## 5. flags フィールド
- `flags` は 8bit の拡張用メタ情報フィールド。ITPS の正規化前提（Mark開始・正/負極性・末尾Space含む）とは独立し、使わないなら 0 とする。
- ビット単位で使っても、値として使ってもよい。本仕様ではビット位置・名称を規定しない（実装依存とする）。

## 6. 反転（INVERTED）の扱い
反転は **ITPSの属性としない**。  
受信・送信の直前（実装依存の HAL 層など）で吸収する。

- ITPSは常に「Mark=正、Space=負」を保証する。
- 反転の有無を記録したい場合は、ITPS外のメタ情報（呼び出し側のコンテキスト）で扱う。
